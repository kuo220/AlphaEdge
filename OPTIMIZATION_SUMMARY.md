# Stock Tick Updater å„ªåŒ–ç¸½çµ

## âœ… å·²å®Œæˆçš„å„ªåŒ–é …ç›®

### ðŸ”´ åš´é‡å•é¡Œä¿®å¾©ï¼ˆé«˜å„ªå…ˆç´šï¼‰

#### 1. âœ… å¤šç·šç¨‹ CSV æ–‡ä»¶ç«¶çˆ­æ¢ä»¶ä¿®å¾©
**æ–‡ä»¶**: `trader/pipeline/cleaners/stock_tick_cleaner.py`

**ä¿®å¾©å…§å®¹**:
- æ·»åŠ äº†é¡žç´šåˆ¥çš„æ–‡ä»¶éŽ–å­—å…¸ (`_file_locks`)ï¼Œç‚ºæ¯å€‹è‚¡ç¥¨ä»£è™Ÿå‰µå»ºç¨ç«‹çš„éŽ–
- ä½¿ç”¨ `threading.Lock` ä¿è­·æ¯å€‹è‚¡ç¥¨çš„æ–‡ä»¶å¯«å…¥æ“ä½œ
- ç¢ºä¿å¤šç·šç¨‹ç’°å¢ƒä¸‹ä¸æœƒåŒæ™‚å¯«å…¥åŒä¸€æ–‡ä»¶

**é—œéµæ”¹é€²**:
```python
# ç²å–æˆ–å‰µå»ºè©²è‚¡ç¥¨çš„æ–‡ä»¶éŽ–
with self._locks_lock:
    if stock_id not in self._file_locks:
        self._file_locks[stock_id] = Lock()
    file_lock = self._file_locks[stock_id]

# ä½¿ç”¨æ–‡ä»¶éŽ–ä¿è­·å¯«å…¥æ“ä½œ
with file_lock:
    # å¯«å…¥æ“ä½œ...
```

---

#### 2. âœ… CSV æ–‡ä»¶è¦†è“‹å°Žè‡´æ•¸æ“šä¸Ÿå¤±ä¿®å¾©
**æ–‡ä»¶**: `trader/pipeline/cleaners/stock_tick_cleaner.py`

**ä¿®å¾©å…§å®¹**:
- ä½¿ç”¨è‡¨æ™‚æ–‡ä»¶æ©Ÿåˆ¶ï¼šå…ˆå¯«å…¥è‡¨æ™‚æ–‡ä»¶ï¼ŒæˆåŠŸå¾Œå†åŽŸå­æ€§åœ°ç§»å‹•åˆ°ç›®æ¨™ä½ç½®
- å¦‚æžœå¯«å…¥å¤±æ•—ï¼Œè‡¨æ™‚æ–‡ä»¶æœƒè¢«è‡ªå‹•æ¸…ç†ï¼Œä¸æœƒå½±éŸ¿åŽŸæœ‰æ•¸æ“š
- ä½¿ç”¨ `tempfile.mkstemp()` å‰µå»ºè‡¨æ™‚æ–‡ä»¶ï¼Œç¢ºä¿å”¯ä¸€æ€§

**é—œéµæ”¹é€²**:
```python
# ä½¿ç”¨è‡¨æ™‚æ–‡ä»¶ï¼ŒæˆåŠŸå¾Œå†è¦†è“‹ç›®æ¨™æ–‡ä»¶
temp_fd, temp_path = tempfile.mkstemp(
    suffix=".csv", dir=self.tick_dir, prefix=f"{stock_id}_"
)
try:
    temp_file = Path(temp_path)
    new_df.to_csv(temp_file, index=False)
    # åŽŸå­æ€§æ“ä½œï¼šå°‡è‡¨æ™‚æ–‡ä»¶ç§»å‹•åˆ°ç›®æ¨™ä½ç½®ï¼ˆè¦†è“‹ï¼‰
    temp_file.replace(csv_path)
except Exception as e:
    # å¦‚æžœå¯«å…¥å¤±æ•—ï¼Œåˆªé™¤è‡¨æ™‚æ–‡ä»¶
    temp_file.unlink()
    raise e
```

---

#### 3. âœ… æ•¸æ“šåˆä½µé‚è¼¯æ”¹é€²
**æ–‡ä»¶**: `trader/pipeline/updaters/stock_tick_updater.py`

**ä¿®å¾©å…§å®¹**:
- æ”¹é€²é‚è¼¯ï¼šå³ä½¿éƒ¨åˆ†æ—¥æœŸå¤±æ•—ï¼Œä¹Ÿä¿å­˜æˆåŠŸçš„æ—¥æœŸæ•¸æ“š
- æ·»åŠ è©³ç´°çš„æ—¥æœŸçµ±è¨ˆè¿½è¹¤ï¼ˆæˆåŠŸã€è·³éŽã€å¤±æ•—ï¼‰
- æ”¹é€²æ—¥èªŒè¨˜éŒ„ï¼Œæ˜Žç¢ºæ¨™ç¤ºå“ªäº›æ—¥æœŸæˆåŠŸã€å“ªäº›å¤±æ•—
- æ·»åŠ ç·šç¨‹ç´šåˆ¥çš„çµ±è¨ˆä¿¡æ¯æ”¶é›†å’ŒåŒ¯ç¸½

**é—œéµæ”¹é€²**:
- åˆ†åˆ¥è¿½è¹¤ `stock_successful_dates`ã€`skipped_dates`ã€`failed_dates`
- å³ä½¿éƒ¨åˆ†æ—¥æœŸå¤±æ•—ï¼Œåªè¦ `df_list` ä¸ç‚ºç©ºï¼Œå°±æœƒä¿å­˜æˆåŠŸçš„æ•¸æ“š
- è¿”å›žçµ±è¨ˆä¿¡æ¯ä¾›å…¨å±€åŒ¯ç¸½

---

### ðŸŸ¡ ä¸­ç­‰å•é¡Œä¿®å¾©

#### 4. âœ… Metadata æ›´æ–°æ™‚æ©Ÿæ”¹é€²ï¼ˆç·šç¨‹å®‰å…¨ï¼‰
**æ–‡ä»¶**: `trader/pipeline/utils/stock_tick_utils.py`

**ä¿®å¾©å…§å®¹**:
- æ·»åŠ é¡žç´šåˆ¥çš„ `_metadata_lock` ä¾†ä¿è­· metadata æ–‡ä»¶çš„è®€å¯«æ“ä½œ
- `update_tick_metadata_from_csv()` å’Œ `load_tick_metadata_stocks()` éƒ½ä½¿ç”¨éŽ–ä¿è­·
- ä½¿ç”¨è‡¨æ™‚æ–‡ä»¶ç¢ºä¿ metadata æ›´æ–°çš„åŽŸå­æ€§
- `check_date_crawled()` ç¾åœ¨æ˜¯ç·šç¨‹å®‰å…¨çš„

**é—œéµæ”¹é€²**:
```python
# ä½¿ç”¨ç·šç¨‹å®‰å…¨çš„éŽ–ä¾†ä¿è­· metadata æ›´æ–°æ“ä½œ
with StockTickUtils._metadata_lock:
    # è®€å–å’Œå¯«å…¥æ“ä½œ...
    # ä½¿ç”¨è‡¨æ™‚æ–‡ä»¶ç¢ºä¿åŽŸå­æ€§
    temp_path = TICK_METADATA_PATH.with_suffix(".tmp")
    # å¯«å…¥è‡¨æ™‚æ–‡ä»¶å¾Œå†ç§»å‹•åˆ°ç›®æ¨™ä½ç½®
```

---

#### 5. âœ… API é…é¡æª¢æŸ¥çµ±ä¸€
**æ–‡ä»¶**: 
- `trader/pipeline/updaters/stock_tick_updater.py`
- `trader/pipeline/crawlers/stock_tick_crawler.py`

**ä¿®å¾©å…§å®¹**:
- ç§»é™¤äº† `crawl_stock_tick` ä¸­çš„é‡è¤‡æª¢æŸ¥
- çµ±ä¸€åœ¨ `update_thread` ä¸­é€²è¡Œæª¢æŸ¥ï¼Œåœ¨æ¯æ¬¡çˆ¬å–å‰æª¢æŸ¥ï¼ˆå› ç‚ºé…é¡æ˜¯å‹•æ…‹è®ŠåŒ–çš„ï¼‰
- æ·»åŠ äº†æ›´å¥½çš„éŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„

**é—œéµæ”¹é€²**:
- åœ¨æ—¥æœŸå¾ªç’°ä¸­ï¼Œæ¯æ¬¡çˆ¬å–å‰éƒ½æª¢æŸ¥ API é…é¡
- å¦‚æžœé…é¡ä¸è¶³ï¼Œè·³å‡ºæ—¥æœŸå¾ªç’°ä½†ç¹¼çºŒè™•ç†ä¸‹ä¸€å€‹è‚¡ç¥¨
- æ·»åŠ äº†ç•°å¸¸è™•ç†ï¼Œå³ä½¿æª¢æŸ¥å¤±æ•—ä¹Ÿä¸æœƒä¸­æ–·æ•´å€‹æµç¨‹

---

#### 6. âœ… éŒ¯èª¤è™•ç†å’Œå ±å‘Šæ©Ÿåˆ¶åŠ å¼·
**æ–‡ä»¶**: `trader/pipeline/updaters/stock_tick_updater.py`

**ä¿®å¾©å…§å®¹**:
- æ·»åŠ å…¨å±€çµ±è¨ˆä¿¡æ¯æ”¶é›†æ©Ÿåˆ¶
- æ¯å€‹ç·šç¨‹è¿”å›žçµ±è¨ˆä¿¡æ¯ï¼Œæœ€å¾ŒåŒ¯ç¸½
- æ·»åŠ  `_print_update_summary()` æ–¹æ³•ï¼Œè¼¸å‡ºå®Œæ•´çš„æ›´æ–°å ±å‘Š
- æ”¹é€²ç•°å¸¸è™•ç†ï¼Œè¨˜éŒ„è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯ï¼ˆä½¿ç”¨ `exc_info=True`ï¼‰
- åœ¨é—œéµæ­¥é©Ÿæ·»åŠ  try-catch å¡Š

**é—œéµæ”¹é€²**:
- å…¨å±€çµ±è¨ˆï¼š`successful_stocks`ã€`failed_stocks`ã€`skipped_stocks` ç­‰
- ç·šç¨‹ç´šåˆ¥çµ±è¨ˆï¼šæ¯å€‹ç·šç¨‹è¿”å›žè‡ªå·±çš„çµ±è¨ˆä¿¡æ¯
- å®Œæ•´çš„æ›´æ–°æ‘˜è¦å ±å‘Šï¼ŒåŒ…æ‹¬æˆåŠŸçŽ‡ã€æ™‚é–“ç­‰

---

#### 7. âœ… CSV æ–‡ä»¶åˆªé™¤ç­–ç•¥æ”¹é€²
**æ–‡ä»¶**: `trader/pipeline/updaters/stock_tick_updater.py`

**ä¿®å¾©å…§å®¹**:
- ä¸å†åˆªé™¤æ‰€æœ‰ CSV æ–‡ä»¶ï¼Œåªåˆªé™¤è‡¨æ™‚æ–‡ä»¶
- ä¿ç•™å·²ç¢ºèªå­˜å…¥è³‡æ–™åº«çš„ CSV æ–‡ä»¶
- æ”¹é€²è‡¨æ™‚æ–‡ä»¶çš„è­˜åˆ¥é‚è¼¯

**é—œéµæ”¹é€²**:
```python
# åªåˆªé™¤è‡¨æ™‚æ–‡ä»¶ï¼ˆä»¥è‚¡ç¥¨ä»£è™Ÿé–‹é ­ä½†åŒ…å«è‡¨æ™‚æ¨™è¨˜çš„æ–‡ä»¶ï¼‰
temp_files = [
    f for f in self.tick_dir.glob("*.csv")
    if "_" in f.stem and f.stem.split("_")[0].isdigit()
]
# ä¿ç•™æ­£å¸¸çš„ CSV æ–‡ä»¶
```

---

### ðŸŸ¢ è¼•å¾®å•é¡Œä¿®å¾©

#### 8. âœ… æ™‚é–“æ ¼å¼é©—è­‰åŠ å¼·
**æ–‡ä»¶**: `trader/pipeline/cleaners/stock_tick_cleaner.py`

**ä¿®å¾©å…§å®¹**:
- åœ¨ `clean_stock_tick` ä¸­åŠ å¼·æ™‚é–“æ ¼å¼è½‰æ›çš„éŒ¯èª¤è™•ç†
- æª¢æŸ¥ä¸¦è™•ç†ç„¡æ•ˆçš„æ™‚é–“å€¼ï¼ˆä½¿ç”¨ `errors="coerce"`ï¼‰
- åœ¨ `format_time_to_microsec` ä¸­åŠ å¼·é©—è­‰é‚è¼¯
- æ·»åŠ æ›´è©³ç´°çš„éŒ¯èª¤æ—¥èªŒ

**é—œéµæ”¹é€²**:
- ä½¿ç”¨ `pd.to_datetime(..., errors="coerce")` è™•ç†ç„¡æ•ˆæ™‚é–“
- æª¢æŸ¥ä¸¦åˆªé™¤ç„¡æ•ˆçš„æ™‚é–“è¡Œ
- æ›´åš´æ ¼çš„å¾®ç§’æ ¼å¼æª¢æŸ¥

---

#### 9. âœ… è³‡æ–™åº«é€£æŽ¥é‡è©¦æ©Ÿåˆ¶
**æ–‡ä»¶**: `trader/pipeline/loaders/stock_tick_loader.py`

**ä¿®å¾©å…§å®¹**:
- åœ¨ `connect()` æ–¹æ³•ä¸­æ·»åŠ é‡è©¦æ©Ÿåˆ¶
- æ”¯æŒé…ç½®æœ€å¤§é‡è©¦æ¬¡æ•¸å’Œé‡è©¦å»¶é²
- æ·»åŠ è©³ç´°çš„é€£æŽ¥æ—¥èªŒ

**é—œéµæ”¹é€²**:
```python
def connect(self, max_retries: int = 3, retry_delay: float = 1.0) -> None:
    for attempt in range(1, max_retries + 1):
        try:
            self.session = ddb.session()
            self.session.connect(DDB_HOST, DDB_PORT, DDB_USER, DDB_PASSWORD)
            return
        except Exception as e:
            if attempt < max_retries:
                logger.warning(f"Connection attempt {attempt}/{max_retries} failed...")
                time.sleep(retry_delay)
            else:
                raise
```

---

#### 10. âœ… è©³ç´°æ—¥èªŒè¨˜éŒ„å’Œçµ±è¨ˆå ±å‘Š
**æ–‡ä»¶**: `trader/pipeline/updaters/stock_tick_updater.py`

**ä¿®å¾©å…§å®¹**:
- æ·»åŠ è©³ç´°çš„æ—¥èªŒè¨˜éŒ„ï¼ŒåŒ…æ‹¬ï¼š
  - æ¯å€‹è‚¡ç¥¨çš„è™•ç†ç‹€æ…‹
  - æ¯å€‹æ—¥æœŸçš„çˆ¬å–çµæžœï¼ˆæˆåŠŸ/å¤±æ•—/è·³éŽï¼‰
  - ç·šç¨‹ç´šåˆ¥çš„çµ±è¨ˆä¿¡æ¯
  - å…¨å±€çµ±è¨ˆæ‘˜è¦
- æ·»åŠ  `_print_update_summary()` æ–¹æ³•ï¼Œè¼¸å‡ºå®Œæ•´çš„æ›´æ–°å ±å‘Š
- æ”¹é€²æ—¥èªŒæ ¼å¼ï¼Œä½¿ç”¨åˆ†éš”ç·šçªå‡ºé‡è¦ä¿¡æ¯

**é—œéµæ”¹é€²**:
- ç·šç¨‹å®Œæˆæ™‚è¼¸å‡ºçµ±è¨ˆä¿¡æ¯
- æ›´æ–°å®Œæˆæ™‚è¼¸å‡ºå®Œæ•´çš„æ‘˜è¦å ±å‘Š
- åŒ…æ‹¬æˆåŠŸçŽ‡ã€è™•ç†æ™‚é–“ç­‰é—œéµæŒ‡æ¨™

---

## ðŸ“Š å„ªåŒ–æ•ˆæžœ

### å®‰å…¨æ€§æå‡
- âœ… æ¶ˆé™¤äº†å¤šç·šç¨‹ç«¶çˆ­æ¢ä»¶
- âœ… é˜²æ­¢æ•¸æ“šä¸Ÿå¤±ï¼ˆè‡¨æ™‚æ–‡ä»¶æ©Ÿåˆ¶ï¼‰
- âœ… ç·šç¨‹å®‰å…¨çš„ metadata æ›´æ–°

### å¯é æ€§æå‡
- âœ… éƒ¨åˆ†å¤±æ•—æ™‚ä»ä¿å­˜æˆåŠŸæ•¸æ“š
- âœ… è³‡æ–™åº«é€£æŽ¥é‡è©¦æ©Ÿåˆ¶
- âœ… æ”¹é€²çš„éŒ¯èª¤è™•ç†å’Œæ¢å¾©

### å¯ç¶­è­·æ€§æå‡
- âœ… è©³ç´°çš„æ—¥èªŒè¨˜éŒ„
- âœ… å®Œæ•´çš„çµ±è¨ˆå ±å‘Š
- âœ… çµ±ä¸€çš„ API é…é¡æª¢æŸ¥é‚è¼¯

### æ€§èƒ½å„ªåŒ–
- âœ… é¿å…ä¸å¿…è¦çš„é‡è¤‡æª¢æŸ¥
- âœ… æ”¹é€²çš„æ–‡ä»¶æ¸…ç†ç­–ç•¥

---

## ðŸ” æ¸¬è©¦å»ºè­°

åœ¨éƒ¨ç½²é€™äº›å„ªåŒ–å¾Œï¼Œå»ºè­°é€²è¡Œä»¥ä¸‹æ¸¬è©¦ï¼š

1. **å¤šç·šç¨‹æ¸¬è©¦**: é©—è­‰å¤šå€‹ç·šç¨‹åŒæ™‚è™•ç†ä¸åŒè‚¡ç¥¨æ™‚ä¸æœƒå‡ºç¾ç«¶çˆ­æ¢ä»¶
2. **éƒ¨åˆ†å¤±æ•—æ¸¬è©¦**: é©—è­‰éƒ¨åˆ†æ—¥æœŸå¤±æ•—æ™‚ï¼ŒæˆåŠŸçš„æ•¸æ“šä»èƒ½æ­£ç¢ºä¿å­˜
3. **ç•°å¸¸æ¢å¾©æ¸¬è©¦**: é©—è­‰åœ¨å„ç¨®ç•°å¸¸æƒ…æ³ä¸‹ï¼ˆAPI å¤±æ•—ã€æ–‡ä»¶å¯«å…¥å¤±æ•—ç­‰ï¼‰ç³»çµ±çš„æ¢å¾©èƒ½åŠ›
4. **Metadata ä¸€è‡´æ€§æ¸¬è©¦**: é©—è­‰ metadata åœ¨å¤šç·šç¨‹ç’°å¢ƒä¸‹çš„æº–ç¢ºæ€§
5. **è³‡æ–™åº«é€£æŽ¥æ¸¬è©¦**: é©—è­‰é€£æŽ¥é‡è©¦æ©Ÿåˆ¶åœ¨ç¶²çµ¡ä¸ç©©å®šæ™‚çš„è¡¨ç¾

---

## ðŸ“ æ³¨æ„äº‹é …

1. **è‡¨æ™‚æ–‡ä»¶æ¸…ç†**: ç³»çµ±æœƒè‡ªå‹•æ¸…ç†è‡¨æ™‚æ–‡ä»¶ï¼Œä½†å¦‚æžœç¨‹åºç•°å¸¸ä¸­æ–·ï¼Œå¯èƒ½éœ€è¦æ‰‹å‹•æ¸…ç†
2. **Metadata å‚™ä»½**: ç³»çµ±æœƒåœ¨æ›´æ–°å‰è‡ªå‹•å‚™ä»½ metadataï¼Œä½†å»ºè­°å®šæœŸæ‰‹å‹•å‚™ä»½
3. **æ—¥èªŒæ–‡ä»¶**: æ—¥èªŒæ–‡ä»¶å¯èƒ½æœƒå¢žé•·è¼ƒå¿«ï¼Œå»ºè­°å®šæœŸæ¸…ç†æˆ–é…ç½®æ—¥èªŒè¼ªè½‰
4. **API é…é¡**: é›–ç„¶æ·»åŠ äº†é…é¡æª¢æŸ¥ï¼Œä½†ä»éœ€ç›£æŽ§ API ä½¿ç”¨æƒ…æ³

---

## ðŸŽ¯ å¾ŒçºŒå„ªåŒ–å»ºè­°

1. **æ•¸æ“šåº«æŸ¥è©¢å„ªåŒ–**: è€ƒæ…®ä½¿ç”¨æ•¸æ“šåº«æŸ¥è©¢ä¾†åˆ¤æ–·æ˜¯å¦éœ€è¦çˆ¬å–ï¼Œè€Œä¸æ˜¯ä¾è³´ metadata æ–‡ä»¶
2. **ä¸¦è¡Œåº¦æŽ§åˆ¶**: æ ¹æ“š API é…é¡å‹•æ…‹èª¿æ•´ç·šç¨‹æ•¸é‡
3. **å¢žé‡æ›´æ–°**: å¯¦ç¾æ›´æ™ºèƒ½çš„å¢žé‡æ›´æ–°ç­–ç•¥
4. **ç›£æŽ§å’Œå‘Šè­¦**: æ·»åŠ ç›£æŽ§æŒ‡æ¨™å’Œå‘Šè­¦æ©Ÿåˆ¶
